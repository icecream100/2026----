# 功能模块详情：视频权限管理

---

## 概述

视频权限管理模块提供视频设备流地址的统一管理能力，分为两个子功能：

| 功能模块 | 核心能力 | 说明 |
|---------|---------|------|
| **直接共享管理** | 查看原始视频流地址 | 直接向应用系统提供视频监控系统原始流地址 |
| **代理共享管理** | 配置代理视频流地址 | 向应用系统提供平台代理转发的流地址 |

---

### 4.1 功能模块: 直接共享管理

#### 4.1.1 功能描述与目标

- **核心能力概述**: 展示系统内所有视频设备的原始流地址信息，供管理员查询和导出，以便外部业务系统直接调用。
- **目标**: 满足第三方业务系统（如安防、可视化大屏）直接调用视频监控系统流地址的需求。

#### 4.1.2 原型参考

- **主要原型页面**:
    - P1.1 (设备列表页 - 直接共享)

#### 4.1.3 详细需求

##### 4.1.3.1 功能入口与触发条件

- **入口**: 视频能力平台 -> 权限管理 -> 直接共享管理
- **触发条件**: 用户登录系统即可访问。

##### 4.1.3.2 交互流程与界面详述

- **主界面布局**:
    - **左侧**: 设备目录树（用于筛选设备范围）
    - **右侧**: 设备列表区域

- **左侧目录树**:
    - 展示系统目录结构
    - 点击目录节点，右侧加载该目录下的设备
    - 显示各目录下的设备数量

- **右侧设备列表**:
    - **筛选条件**:
        - 设备名称 (模糊搜索)
        - 在线状态 (下拉选择: 全部/在线/离线)
        - 操作按钮: 查询、重置
    - **工具栏**:
        - "批量导出": 导出选中设备的流地址信息 (Excel格式)
    - **数据列表字段**:

| 字段名称 | 说明 | 操作 |
|---------|------|------|
| 设备名称 | 摄像头名称 | - |
| 平台编码 | 设备国标编码 | - |
| 在线状态 | 在线/离线，带颜色标识 | - |
| 视频流地址 | 原始 RTSP/RTMP 流地址 | [复制] |

- **行内操作**:
    - **复制**: 点击后复制流地址到剪贴板，Toast提示"复制成功"

##### 4.1.3.3 字段定义与数据规则

**设备列表字段**

| 字段名称 | 字段标识 | 数据类型 | 界面显隐/读写 | 备注 |
|---------|---------|---------|-------------|------|
| 设备名称 | `deviceName` | String | 显示/只读 | |
| 平台编码 | `deviceCode` | String | 显示/只读 | 国标20位编码 |
| 在线状态 | `onlineStatus` | Enum | 显示/只读 | 在线(绿)/离线(灰) |
| 视频流地址 | `streamUrl` | String | 显示/只读 | 原始流地址，如 rtsp://... |

#### 4.1.4 业务规则

- **数据范围**: 展示系统内全部视频设备，无权限过滤。
- **流地址来源**: 由设备接入时自动生成，不可编辑。

---

### 4.2 功能模块: 代理共享管理

#### 4.2.1 功能描述与目标

- **核心能力概述**: 管理视频设备的代理流地址配置，支持批量配置或手动输入代理流地址，供外部系统通过平台代理方式访问视频流。
- **目标**: 满足需要通过平台进行流量代理转发的场景（如网络隔离环境、统一安全出口等）。

#### 4.2.2 原型参考

- **主要原型页面**:
    - P2.1 (设备列表页 - 代理共享)
    - P2.2 (批量配置代理弹窗)

#### 4.2.3 详细需求

##### 4.2.3.1 功能入口与触发条件

- **入口**: 视频能力平台 -> 权限管理### 3.2 代理共享

代理共享是指平台作为代理服务，将内部设备的原始视频流（如RTSP/GB28181）转换为标准的流媒体地址（如HTTP-FLV, HLS, RTMP等），供外部系统或大屏调用。

#### 3.2.1 功能要求

1.  **设备列表**：展示所有设备，支持按目录树筛选。
2.  **状态展示**：
    *   **在线状态**：设备的实时在线状态。
    *   **代理状态**：是否已配置代理（已配置/未配置）。
3.  **流地址展示**：
    *   **原始流地址**：设备本身的RTSP或国标ID。
    *   **代理流地址**：配置代理后生成的对外服务地址（展示主协议地址）。
4.  **批量配置代理**：
    *   支持选择多个设备进行批量配置。
    *   **配置字段**：
        *   **服务地址 (Service Host)**: 代理服务器的IP或域名（如 `video.jhit.edu.cn`）。
        *   **服务端口 (Service Port)**: 服务端口（如 `80`, `1935`）。
        *   **应用名称 (App Name)**: 路径标识（默认 `live`）。
        *   **流ID规则 (Stream ID Rule)**: 生成流ID的规则，支持变量 `{DeviceCode}`（设备编码）。
        *   **主协议 (Protocol)**: **单选**，支持 `HTTP-FLV`, `HLS`, `RTMP`, `RTSP`。表格中展示该协议对应的地址。
    *   **预览功能**：根据输入实时预览**所有协议**的流地址格式（作为参考），用户选择的主协议将作为存储和展示的地址。
5.  **单独编辑**：
    *   点击设备行的"编辑"按钮，弹出配置弹窗。
    *   支持两种模式：
        *   **自动生成模式（默认）**：与批量配置相同，配置字段后系统自动生成地址。
        *   **手动输入模式**：切换后直接输入完整的代理流地址，适用于特殊场景。
6.  **批量清除**：支持批量清除已配置的代理信息。
7.  **批量导出**：导出设备列表及所有流地址信息。

#### 3.2.2 字段定义

| 字段名称 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| 设备名称 | 文本 | 是 | |
| 平台编码 | 文本 | 是 | 设备的唯一标识符 |
| 在线状态 | 枚举 | 是 | 在线/离线 |
| 原始流地址 | 文本 | 否 | 设备原始RTSP地址或GBID |
| 代理状态 | 枚举 | 是 | 已配置/未配置 |
| 代理流地址 | 文本 | 否 | 生成的对外播放地址 |
| 服务地址 | 文本 | 是 | 代理服务器IP/域名 |
| 服务端口 | 数字 | 是 | 端口号 |
| 应用名称 | 文本 | 是 | 默认为 live |
| 协议类型 | 枚举 | 是 | RTSP/RTMP/FLV/HLS |

- **核心操作流程**:

    - **A. 批量配置代理流程**:
        - **触发**: 勾选多个设备 -> 点击"批量配置代理"
        - **交互步骤**:
            - Step 1: 弹出"批量配置代理"弹窗
            - Step 2: 用户配置代理参数:
                - **代理服务器地址**: 输入框，如 `http://proxy.example.com`
                - **生成规则**: 可选配置，默认为 `{代理服务器地址}/stream/{设备编码}`
            - Step 3: 点击"确定"
            - Step 4: 系统为每个选中设备生成代理流地址并保存
            - Step 5: 刷新列表，Toast提示"配置成功，共更新 N 条"

    - **B. 单个编辑代理流程**:
        - **触发**: 点击设备行的"编辑"按钮
        - **交互步骤**:
            - Step 1: 弹出"编辑代理地址"弹窗
            - Step 2: 用户手动输入该设备的代理流地址
            - Step 3: 点击"确定"保存
            - Step 4: 刷新该行数据

    - **C. 批量清除代理流程**:
        - **触发**: 勾选多个设备 -> 点击"批量清除代理"
        - **交互步骤**:
            - Step 1: 弹出确认框："确定清除选中设备的代理配置吗？"
            - Step 2: 用户点击"确定"
            - Step 3: 清除选中设备的代理流地址字段
            - Step 4: 刷新列表，Toast提示"已清除 N 条代理配置"

##### 4.2.3.3 字段定义与数据规则

**设备列表字段**

| 字段名称 | 字段标识 | 数据类型 | 界面显隐/读写 | 备注 |
|---------|---------|---------|-------------|------|
| 设备名称 | `deviceName` | String | 显示/只读 | |
| 平台编码 | `deviceCode` | String | 显示/只读 | 国标20位编码 |
| 在线状态 | `onlineStatus` | Enum | 显示/只读 | 在线(绿)/离线(灰) |
| 原始流地址 | `streamUrl` | String | 显示/只读 | 设备原始流地址 |
| 代理状态 | `proxyStatus` | Enum | 显示/只读 | 根据代理流地址是否为空自动计算 |
| 代理流地址 | `proxyUrl` | String | 显示/读写 | 可批量配置或手动输入 |

**批量配置代理参数**

| 字段名称 | 字段标识 | 数据类型 | 必填 | 约束/规则 |
|---------|---------|---------|------|----------|
| 代理服务器地址 | `proxyServer` | String | 是 | 必须为有效的 URL 格式 |
| 生成规则 | `urlPattern` | String | 否 | 支持变量: `{设备编码}`、`{设备名称}` |

#### 4.2.4 业务规则

- **代理状态自动计算**: 当 `proxyUrl` 字段有值时，代理状态显示"已配置"；为空时显示"未配置"。
- **批量配置覆盖**: 批量配置时，若设备已有代理地址，会被新配置覆盖。
- **地址格式校验**: 代理流地址应为有效的 HTTP/HTTPS/RTSP 格式。

---

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|-----|------|---------|------|
| V2.0 | 2026-02-09 | 简化设计：取消应用管理和上级平台管理，改为以设备为核心的流地址管理 | - |
| V1.0 | - | 初始版本：含应用管理、GB28181级联等功能 | - |
