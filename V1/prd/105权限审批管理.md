# 功能模块详情：权限审批管理

---

### 4.1 功能模块: 权限申请 (开发者)

#### 4.1.1 功能描述与目标

- **核心能力概述**: 为应用开发者提供发起设备数据访问权限申请的能力，支持按设备或按标签（区域/类型）批量申请，并提供申请记录的查询、撤回和重新申请功能。
- **目标**: 规范化第三方应用获取设备数据的流程，确保需求可追溯。

#### 4.1.2 原型参考

- **主要原型页面**:
    - P1.1 (需求登记列表页)
    - P1.2 (新增需求弹窗/页面)
    - P1.3 (需求详情页)
    - P1.4 (已授权设备清单弹窗)

#### 4.1.3 详细需求

##### 4.1.3.1 功能入口与触发条件

- **入口**:
    - 开发者工作台 -> 权限申请管理 -> 需求登记记录 [参考原型 P1.1]
- **触发条件**:
    - 用户需拥有“开发者”角色。
    - 当前账号下需有已注册且状态为“启用”的应用。

##### 4.1.3.2 交互流程与界面详述

- **主界面/列表描述 (需求登记记录)**:
    - **布局**: 标准列表布局。顶部为搜索/筛选区，中部为操作栏，下部为数据列表。
    - **包含元素**:
        - **筛选条件**: 关联应用 (下拉选择)、状态 (待审批/已通过/已驳回/已过期/已撤销/已撤回)、申请时间 (日期范围)。
        - **操作按钮**: "新增需求" (高亮显示)。
        - **数据列表**: 申请单号、关联应用、申请理由 (摘要)、申请时间、当前状态、审核人、审核时间、操作列。
    - **默认交互**: 列表按“申请时间”倒序排列。

- **核心操作流程细化**:

    - **A. 新增需求流程**:
        - **触发**: 点击列表页右上角“新增需求”按钮。
        - **交互步骤**:
            - Step 1: 系统打开“新增需求”页面或弹窗 [参考原型 P1.2]。
            - Step 2: 用户选择 **关联应用** (必选，仅展示当前账号下已启用的应用)。
            - Step 3: 用户选择 **数据范围** (必选)。
                - 交互: 支持切换“按设备选择”或“按标签选择”Tab。
                - **按设备**: 弹出设备选择树/列表，支持搜索、多选。选中后在主表单显示已选设备数量及清单预览。**(默认为快照授权)**
                - **按标签**: 下拉选择特定标签（如“行政楼”、“监控设备”）。**(默认为动态授权)**
            - Step 4: 用户设置 **申请期限** (必选)。
                - 交互: 选择“固定期限”并填写开始/结束日期，或勾选“长期有效”。
            - Step 5: 用户填写 **申请理由** (必填)。
            - Step 6: 点击“提交”按钮。
            - Step 7: **前端校验**: 检查必填项、字符长度。若校验失败，在对应字段下方显示红色错误提示。
            - Step 8: **结果处理**:
                - 成功: 提示“申请已提交”，关闭页面/弹窗，刷新列表，首行显示新生成的申请单，状态为“待审批”。
                - 失败: Toast提示具体错误原因（如“网络异常”）。

    - **B. 查看详情与授权流程**:
        - **触发**: 点击列表操作列的“查看详情”或“查看授权”。
        - **交互步骤**:
            - **查看详情**: 弹窗展示申请单完整信息（含审批意见）。若状态为“已驳回”，重点展示驳回原因。
            - **查看授权**: 仅“已通过”状态可用。点击后弹窗展示最终获批的设备清单（因为管理员可能微调过）。

    - **C. 撤回申请流程**:
        - **触发**: 点击列表操作列的“撤回”按钮（仅“待审批”状态可见）。
        - **交互步骤**:
            - Step 1: 弹出二次确认框：“确定要撤回该申请吗？撤回后可修改重新提交。”
            - Step 2: 用户点击“确定”。
            - Step 3: 系统更新状态为“已撤回”。

    - **D. 重新申请流程**:
        - **触发**: 针对“已驳回”、“已过期”或“已撤回”的单据，点击“重新申请”/“修改”按钮。
        - **交互步骤**:
            - Step 1: 打开新增需求页面，自动回填原单据的所有信息（应用、范围、期限、理由）。
            - Step 2: 用户修改必要信息后再次提交。

- **状态定义**:
    - **待审批**: 申请已提交，等待管理员处理。
    - **已通过**: 管理员已同意，权限生效中（或待生效）。
    - **已驳回**: 管理员拒绝了申请。
    - **已过期**: 授权期限已截止。
    - **已撤销**: 管理员强制收回了权限。
    - **已撤回**: 申请人主动撤回。

##### 4.1.3.3 字段定义与数据规则

| 字段名称   | 字段标识 (Eng)   | 数据类型 & 长度     | 界面显隐/读写 | 约束/规则                         | 数据来源/去向   | 备注  |
| ------ | ------------ | ------------- | ------- | ----------------------------- | --------- | --- |
| 关联应用   | `appId`      | String (UUID) | 显示/读写   | 必填，单选，仅显示Status=Enable的应用     | 基础数据-应用管理 |     |
| 数据范围类型 | `scopeType`  | Enum          | 显示/读写   | 必填，Device(设备) / Label(标签)     | 用户选择      |     |
| 数据范围值  | `scopeValue` | List          | 显示/读写   | 必填，至少选择1个节点                   | 用户选择      |     |
| 申请期限类型 | `termType`   | Enum          | 显示/读写   | 必填，Fixed(固定) / Long(长期)       | 用户选择      |     |
| 开始日期   | `startDate`  | Date          | 显示/读写   | `termType`=Fixed时必填           | 用户选择      |     |
| 结束日期   | `endDate`    | Date          | 显示/读写   | `termType`=Fixed时必填，需 >= 开始日期 | 用户选择      |     |
| 申请理由   | `reason`     | String (500)  | 显示/读写   | 必填，10-500字符                   | 用户输入      |     |
| 申请单状态  | `status`     | Enum          | 显示/只读   | 默认“待审批”                       | 系统流转      |     |

##### 4.1.3.4 权限控制

- **功能访问权限**: 仅“开发者”角色可访问。
- **数据权限**: 只能查看和操作当前登录用户（或所属团队）创建的申请单。

#### 4.1.4 业务规则

- **状态流转逻辑**:
    ```mermaid
    stateDiagram-v2
        [*] --> 待审批: 提交申请
        待审批 --> 已撤回: 申请人撤回
        待审批 --> 已驳回: 管理员驳回
        待审批 --> 已通过: 管理员通过(生成授权)
        state 已通过 {
            [*] --> 生效中
            生效中 --> 已过期: 到达截止日期
            生效中 --> 已撤销: 管理员强制收回
        }
        已驳回 --> 待审批: 复制/修改并重新申请
        已过期 --> 待审批: 续期/重新申请
        已撤回 --> 待审批: 修改后重新提交
    ```
- **权限合并逻辑**: 若同一应用对同一设备多次申请（例如先申请了A设备，又申请了包含A设备的标签），系统采用**叠加（并集）**策略。只要有一条有效的授权记录覆盖该设备，应用即拥有访问权限。
- **默认授权模式**:
    - **按设备申请**: 默认为**快照授权**（Snapshot）。即申请时的设备集合被固定，后续设备变更不影响此申请单。
    - **按标签申请**: 默认为**动态授权**（Dynamic）。即绑定标签关系，后续该标签下新增的设备自动继承此权限。

#### 4.1.5 异常处理方案

- **数据范围为空**: 若用户选择标签后，该标签下暂时无设备，前端给予提示“当前标签下暂无设备，是否确认申请？”，允许提交（预期未来会有设备）。
- **重复申请**: 系统允许对同一应用、同一范围重复提交申请（可能是为了续期或变更期限），不进行强拦截，但可提示“存在生效中的相同范围授权”。

#### 4.1.6 与其他功能的关联和依赖

- **依赖于**:
    - **应用管理**: 获取可选的应用列表。
    - **设备管理/标签管理**: 获取设备树和标签列表用于选择数据范围。

---

### 4.2 功能模块: 需求审批 (管理员)

#### 4.2.1 功能描述与目标

- **核心能力概述**: 管理员对开发者提交的权限申请进行审核，支持查看申请详情、调整授权范围（微调）、设置最终期限，并做出通过或驳回的决策。
- **目标**: 严格把控数据出口，确保数据安全，同时提供灵活的授权调整能力。

#### 4.2.2 原型参考

- **主要原型页面**:
    - P2.1 (待办任务列表)
    - P2.2 (审批详情与决策页)
    - P2.3 (已办任务列表)
    - P2.4 (已办详情只读页)

#### 4.2.3 详细需求

##### 4.2.3.1 功能入口与触发条件

- **入口**: 管理平台 -> 权限申请管理 -> 需求审批 [参考原型 P2.1]
- **触发条件**: 必须具备“管理员”或“数据审核员”权限。

##### 4.2.3.2 交互流程与界面详述

- **主界面/列表描述**:
    - **Tab切换**: 待办任务 (默认) / 已办任务。
    - **待办任务列表**: 展示所有状态为“待审批”的申请单。操作列显示“审批”按钮。
    - **已办任务列表**: 展示历史审批记录。操作列显示“查看”按钮。

- **核心操作流程细化**:

    - **A. 审批流程 (待办)**:
        - **触发**: 点击待办列表中的“审批”按钮。
        - **交互步骤**:
            - Step 1: 进入审批详情页 [参考原型 P2.2]。页面展示申请人信息、应用信息、申请理由、申请的数据范围。
            - Step 2: **审查与决策**: 管理员查看信息后，选择“通过”或“驳回”。
            - Step 3 (分支一): **选择“通过”**:
                - **设置授权策略 (针对标签申请)**:
                    - 单选框: 保持动态授权 (默认) / 转换为快照授权。
                    - *说明*: 动态授权意味着后续该标签新增设备自动授权；快照授权则固定为当前时刻的设备列表。
                - **调整授权范围 (权限微调)**:
                    - 界面: **内嵌式左右双栏选择器**。
                    - 左栏: “可选设备库”（支持搜索、按区域筛选）。
                    - 右栏: “拟授权设备”（默认加载申请单中的设备）。
                    - 操作: 管理员可从左侧勾选添加，或从右侧移除，最终以右栏列表为准。
                - **确认期限**:
                    - 输入框: 默认回显申请人填写的期限，管理员可修改（例如缩短期限）。
                - **提交**: 点击“确认通过”按钮。系统生成授权记录，下发ACL策略，通知申请人。
            - Step 3 (分支二): **选择“驳回”**:
                - **填写原因**: 出现多行文本框“驳回原因” (必填)。
                - **提交**: 点击“确认驳回”按钮。系统更新状态，发送通知。

##### 4.2.3.3 字段定义与数据规则

| 字段名称 | 字段标识 (Eng) | 数据类型 & 长度 | 界面显隐/读写 | 约束/规则 | 数据来源/去向 | 备注 |
|---|---|---|---|---|---|---|
| 审批结果 | `auditResult` | Enum | 显示/读写 | 必填，Pass/Reject | 管理员输入 | |
| 授权策略 | `authStrategy` | Enum | 显示/读写 | 仅Pass时可见，Dynamic/Snapshot | 管理员输入 | 针对标签申请 |
| 最终授权设备 | `finalDeviceList` | List | 显示/读写 | 仅Pass时可见，至少1个 | 管理员调整 | 默认为申请范围 |
| 批准期限 | `approvedTerm` | DateRange | 显示/读写 | 仅Pass时可见，必填 | 管理员输入 | 默认为申请期限 |
| 驳回原因 | `rejectReason` | String (200) | 显示/读写 | 仅Reject时必填，Max 200字符 | 管理员输入 | |

##### 4.2.3.4 权限控制

- **操作权限**: 仅“管理员”可执行审批操作。

#### 4.2.4 业务规则

- **授权生效机制**: 审批通过后，系统应立即计算出具体的设备列表（若是快照模式）或建立标签绑定关系（若是动态模式），并将权限策略推送到网关或鉴权服务。
- **冲突处理**: 若管理员调整后的设备列表为空，禁止“确认通过”，提示“授权设备不能为空”。

#### 4.2.5 异常处理方案

- **并发审批**: 若多个管理员同时打开同一单据，第一个提交的人生效。后续提交者提示“该单据已被处理”，并刷新页面。

---

### 4.3 功能模块: 授权管理 (管理员)

#### 4.3.1 功能描述与目标

- **核心能力概述**: 提供全局视角的授权关系查询，支持按应用、设备维度检索生效中的权限，并具备强制撤销（收回）权限的能力。
- **目标**: 监控数据开放状态，快速响应安全风险（如应用泄露需紧急阻断）。

#### 4.3.2 原型参考

- **主要原型页面**:
    - P3.1 (授权管理列表页)
    - P3.2 (授权详情弹窗)
    - P3.3 (强制撤销确认弹窗)

#### 4.3.3 详细需求

##### 4.3.3.1 功能入口与触发条件

- **入口**: 管理平台 -> 权限申请管理 -> 授权管理 [参考原型 P3.1]

##### 4.3.3.2 交互流程与界面详述

- **主界面/列表描述**:
    - **筛选条件**: 应用名称 (模糊搜索)、设备标识 (精确搜索)、状态 (生效中/已过期/已撤销)、到期时间 (范围)。
    - **数据列表**: 授权ID、被授应用、授权范围摘要 (如“设备A等10个设备”或“行政楼(标签)” )、生效时间、失效时间、状态、操作。
    - **默认排序**: 按失效时间升序（优先展示即将过期的）。

- **核心操作流程细化**:

    - **A. 查看详情**:
        - **触发**: 点击“详情”按钮。
        - **交互**: 弹窗展示该条授权记录的详细信息，包括当初的申请单号、审批人、以及**当前包含的具体设备清单**（特别是动态标签授权，需展示当前实时计算出的设备列表）。

    - **B. 强制撤销 (权限收回)**:
        - **触发**: 点击“撤销”按钮（仅“生效中”状态可见）。
        - **交互步骤**:
            - Step 1: 弹出高风险警告框 [参考原型 P3.3]：“确定要收回 [应用名] 对 [范围摘要] 的访问权限吗？此操作立即生效且不可恢复。”
            - Step 2: 用户填写 **撤销备注** (必填，用于留档和通知开发者)。
            - Step 3: 点击“确定”。
            - Step 4: 系统立即清除ACL策略，更新状态为“已撤销”。列表自动刷新。

##### 4.3.3.3 字段定义与数据规则

| 字段名称 | 字段标识 (Eng) | 数据类型 & 长度 | 界面显隐/读写 | 约束/规则 | 数据来源/去向 | 备注 |
|---|---|---|---|---|---|---|
| 撤销备注 | `revokeReason` | String (200) | 弹窗显示/读写 | 必填，Max 200字符 | 管理员输入 | |

##### 4.3.3.4 权限控制

- **操作权限**: 仅超级管理员或安全管理员可执行“强制撤销”操作。

#### 4.3.4 业务规则

- **权限原则**: 设备所有者（Owner）拥有其名下所有设备的全量访问权限，**不在**本模块管理范围内。本模块仅管理第三方应用或非所有者的授权记录。
- **撤销影响**: 撤销操作应实时生效（或在分钟级延迟内生效），已建立的长连接可能会被断开或在下一次心跳/请求时被拒绝。

#### 4.3.5 异常处理方案

- **数据不一致**: 若在查看详情时，发现关联的设备已被物理删除，应在列表中标记为“设备不存在”或自动从授权清单中剔除（取决于系统的数据一致性策略，建议展示但标记失效）。

#### 4.3.6 与其他功能的关联和依赖

- **依赖于**:
    - **设备列表**: 实时获取设备状态和详情。
